<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reproductor — Cine en Castellano HD</title>
  <style>
    :root { --bg:#0b0b0b; --fg:#eee; --muted:#9aa0a6; --accent:#29b6f6; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif}
    header{display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;border-bottom:1px solid #1f1f1f;background:#101010;position:sticky;top:0;z-index:10}
    header h1{font-size:1rem;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
    header button,a.btn{background:#1a1a1a;border:1px solid #222;border-radius:12px;color:var(--fg);padding:.5rem .75rem;cursor:pointer}
    main{position:relative;height:calc(100% - 56px);}
    #wrap{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:#000}
    video{max-width:100%;max-height:100%;width:100%;height:100%;background:#000}
    /* Floating controls */
    .fab{position:fixed;right:12px;bottom:12px;display:flex;gap:8px;z-index:20}
    .fab > *{box-shadow:0 8px 24px rgba(0,0,0,.4);border-radius:999px;overflow:hidden}
    google-cast-launcher{width:48px;height:48px;background:#1f1f1f;border:1px solid #2b2b2b}
    .airplay{width:48px;height:48px;display:grid;place-items:center;background:#1f1f1f;border:1px solid #2b2b2b}
    .airplay svg{width:24px;height:24px;fill:#fff;opacity:.9}
    .hidden{display:none!important}
  </style>
  <!-- Google Cast Sender SDK -->
  <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
</head>
<body>
  <header>
    <button id="backBtn" title="Volver">←</button>
    <h1 id="title">Reproductor</h1>
    <a id="openDirect" class="btn" target="_blank" rel="noreferrer">Abrir fuente</a>
  </header>
  <main>
    <div id="wrap">
      <video id="vid" playsinline controls controlsList="nodownload noplaybackrate">
        <!-- src seteado por la URL -->
      </video>
    </div>
    <div class="fab" id="floatingBtns">
      <!-- Cast button (Chrome/Edge/Android TV) -->
      <google-cast-launcher id="castBtn" aria-label="Enviar al televisor"></google-cast-launcher>
      <!-- AirPlay button (Safari/iOS/macOS) -->
      <button class="airplay" id="airplayBtn" title="AirPlay">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M6 22h12l-6-6-6 6zm13-9h1a3 3 0 003-3V7a3 3 0 00-3-3H4a3 3 0 00-3 3v3a3 3 0 003 3h1v-2H4a1 1 0 01-1-1V7a1 1 0 011-1h16a1 1 0 011 1v3a1 1 0 01-1 1h-1v2z"/>
        </svg>
      </button>
    </div>
  </main>

  <script>
    function qs(key){return new URLSearchParams(location.search).get(key)||''}
    function safeDecode(s){try{return decodeURIComponent(s)}catch(_){return s}}
    const src   = safeDecode(qs('src'));
    const title = safeDecode(qs('title')) || 'Reproductor';
    const poster= safeDecode(qs('poster')) || '';

    const vid = document.getElementById('vid');
    const titleEl = document.getElementById('title');
    const openDirect = document.getElementById('openDirect');
    titleEl.textContent = title;
    openDirect.href = src;

    vid.src = src;
    if (poster) vid.poster = poster;

    if ('mediaSession' in navigator){
      navigator.mediaSession.metadata = new MediaMetadata({
        title: title,
        artist: 'Cine en Castellano HD',
        artwork: poster ? [{src: poster, sizes: '600x900', type:'image/jpeg'}] : []
      });
    }

    document.getElementById('backBtn').onclick = () => {
      if (history.length > 1) history.back(); else location.href = '/';
    };

    const fab = document.getElementById('floatingBtns');
    function syncFab(){
      const fsEl = document.fullscreenElement || document.webkitFullscreenElement;
      fab.classList.toggle('hidden', !!fsEl);
    }
    ['fullscreenchange','webkitfullscreenchange'].forEach(ev => document.addEventListener(ev, syncFab));

    const airBtn = document.getElementById('airplayBtn');
    function airplaySupported(){
      return !!(window.WebKitPlaybackTargetAvailabilityEvent && typeof vid.webkitShowPlaybackTargetPicker === 'function');
    }
    if (!airplaySupported()){
      airBtn.classList.add('hidden');
    } else {
      airBtn.addEventListener('click', () => {
        try { vid.webkitShowPlaybackTargetPicker(); } catch(e){ console.warn(e); }
      });
      vid.addEventListener('webkitplaybacktargetavailabilitychanged', (e) => {
        airBtn.classList.toggle('hidden', e.availability !== 'available');
      });
    }

    window.__onGCastApiAvailable = function(isAvailable) {
      if (!isAvailable) return;
      const context = cast.framework.CastContext.getInstance();
      context.setOptions({
        receiverApplicationId: 'CC1AD845',
        autoJoinPolicy: chrome.cast.AutoJoinPolicy.TAB_AND_ORIGIN_SCOPED
      });
      const stateChanged = async () => {
        const s = context.getSessionState();
        if (s === cast.framework.SessionState.SESSION_STARTED || s === cast.framework.SessionState.SESSION_RESUMED){
          const mediaInfo = new chrome.cast.media.MediaInfo(src, 'video/mp4');
          if (poster){
            mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
            mediaInfo.metadata.title = title;
            mediaInfo.metadata.images = [{url: poster}];
          }
          const request = new chrome.cast.media.LoadRequest(mediaInfo);
          try {
            await context.getCurrentSession().loadMedia(request);
          } catch(err){ console.warn('Cast load failed', err); }
        }
      };
      context.addEventListener(cast.framework.CastContextEventType.SESSION_STATE_CHANGED, stateChanged);
    };
  </script>
</body>
</html>
